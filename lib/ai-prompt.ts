import { FortuneStick } from './fortune-sticks'

export const generateOraclePrompt = (fortuneStick: FortuneStick, question: string) => {
  return `【核心任务：针对用户问题的个性化解读】

═══════════════════════════════════════════════════════
【第一步：理解用户问题的核心】
═══════════════════════════════════════════════════════

求签者的问题（这是最重要的信息，必须优先分析）：
"${question}"

请先分析这个问题的核心关切：
- 问题涉及哪个领域？（工作、感情、健康、学业、人际关系等）
- 问题的本质是什么？（选择困难、关系困惑、未来担忧等）
- 用户可能面临的具体困境是什么？

═══════════════════════════════════════════════════════
【第二步：结合签文智慧】
═══════════════════════════════════════════════════════

签文信息（作为参考，用于结合用户问题）：
- 签号：第${fortuneStick.number}签
- 等级：${fortuneStick.level}
- 签诗："${fortuneStick.content}"
- 典故：${fortuneStick.story ? `"${fortuneStick.story}" - ${fortuneStick.storyBrief}` : fortuneStick.storyBrief || '无'}
- 启示：${fortuneStick.detail2 || '无'}

═══════════════════════════════════════════════════════
【关键要求（必须严格遵守）】
═══════════════════════════════════════════════════════

⚠️ 重要：你的解读必须直接回答用户的问题，不能是通用解读！

1. 必须针对用户的具体问题：
   - 如果用户问"TA喜欢我吗？"，解读必须围绕感情关系、对方态度、关系发展
   - 如果用户问"该不该换工作？"，解读必须围绕职业选择、工作环境、职业发展
   - 如果用户问"我们有复合的可能吗？"，解读必须围绕复合可能性、关系修复、双方状态
   - 禁止给出与问题无关的通用建议

2. 不要重复签文内容：
   - 页面已经显示了签诗、典故和启示，用户已经看到了
   - 你的任务是结合这些签文信息，针对用户的具体问题提供深度分析
   - 不要重复签诗的字面意思，不要重复典故的故事情节，不要重复启示的通用解释

3. 解读逻辑：
   - 先理解用户问题的核心 → 再结合签文的智慧 → 最后给出针对性的建议
   - 例如：用户问"TA喜欢我吗？" + 抽到上签 → 解读应该分析"这段感情的发展趋势如何？对方可能的态度是什么？"
   - 例如：用户问"该不该换工作？" + 抽到下签 → 解读应该分析"当前工作环境的问题是什么？换工作的时机是否合适？"

═══════════════════════════════════════════════════════
【输出要求】
═══════════════════════════════════════════════════════

请生成一个深度解读，格式化为JSON，包含以下字段：

⚠️ 重要：每个字段的职责必须明确，不能混淆！

1. "insight": 针对用户问题的深度分析（400-500字，必须丰富翔实、有画面感）
   ⚠️ 这个字段必须包含以下四个子部分，不能把内容放到其他字段：
   - 【必须】直接回答用户的问题，不能是通用解读
   - 【必须】将签诗的每个意象、每个词句都映射到用户的具体问题上
   - 【必须】采用以下结构进行分析（参考优秀解读示例）：
     
     **当前状态（对应签诗中的某个意象）**：
     - 将签诗中的某个意象（如"旱象"、"雨"、"三日"等）映射到用户当前的心理状态和实际情况
     - 用比喻和类比来描述用户的心境，让用户产生共鸣
     - 例如：签诗说"旱象较多" → 映射到"您目前的心境——焦虑、忐忑、感觉希望渺茫，就像久旱盼雨一样"
     
     **事情本质（签诗的深层含义）**：
     - 解释签诗的核心寓意（如"先忧后喜"、"约定有成"等）
     - 说明这个寓意如何回应用户的问题本质
     - 例如：签诗说"皆由天数" → 映射到"缘分的深浅、情感的走向，有其自然的规律与时机"
     
     **关键转折（签文给出的积极/消极信号）**：
     - 从签诗中找出关键的转折点或信号（如"三日内"、"雨滂沱"等）
     - 将这个转折点映射到用户问题的未来发展
     - 给出明确的时间暗示或可能性分析
     - 例如：签诗说"三日内" → 映射到"在不久的将来会得到答案，事情即将明朗"
     - 例如：签诗说"雨滂沱" → 映射到"您可能会通过一次深入的交谈、一个明确的事件，获得您所期待的答案"
     
     **综合判断**（必须包含，不能省略）：
     - 基于以上分析，给出对用户问题的综合判断
     - 明确说明签文对用户问题的指示是积极还是消极
     - 总结核心要点
     - 给出明确的答案方向（例如：复合可能性高/低，对方态度积极/消极等）
     - 这个部分必须存在，不能省略！
   
   - 【必须】语言风格要求：
     * 优雅、有文学性，有画面感
     * 用比喻和类比来解释（如"如久旱逢甘霖"、"如干涸的田地"）
     * 既有古签的韵味，又有现代心理学的洞察
     * 用词精准，让用户产生共鸣
   
   - 【必须】内容要求：
     * 必须将签诗的每个关键意象都映射到用户的问题上
     * 必须给出明确的心理状态描述
     * 必须给出明确的时间暗示或可能性分析
     * 必须给出明确的答案方向（积极/消极/中性）
     * 内容必须丰富、翔实、有深度，不能是简单的几句话
   
   - 在文本中，用**双星号**标记2-3句最启发性的句子，例如：**"你的实际启发句子"**
   
   - 【必须】格式要求（这是最重要的，必须严格遵守）：
     * ⚠️ 必须包含所有四个子部分：**当前状态**、**事情本质**、**关键转折**、**综合判断**（缺一不可！）
     * ⚠️ 每个子部分都必须有标题和内容，不能只有标题没有内容，也不能只有内容没有标题
     * ⚠️ 每个子部分之间必须用双换行符（\n\n）分隔
     * ⚠️ 每个子部分内部可以有多个段落，段落之间用单换行符（\n）分隔
     * ⚠️ 子标题（如"**当前状态**"）后面必须换行，然后才是内容
     * ⚠️ 格式示例（必须严格按照这个格式，不能省略任何部分）：
       
       **当前状态（对应签诗中的某个意象）**：
       这里是当前状态的内容，必须详细描述用户当前的心理状态和实际情况，可以有多段...
       
       **事情本质（签诗的深层含义）**：
       这里是事情本质的内容，必须解释签诗的核心寓意，说明如何回应用户的问题本质...
       
       **关键转折（签文给出的积极/消极信号）**：
       这里是关键转折的内容，必须从签诗中找出转折点，映射到未来发展，给出时间暗示...
       
       **综合判断**：
       这里是综合判断的内容，必须包含明确的答案方向（积极/消极/中性），总结核心要点...
     
     * ⚠️ 如果只生成部分子部分（比如只有"当前状态"），这是错误的！必须生成所有四个子部分！

2. "guidance": 基于签文智慧的行动建议（300-400字，必须详细具体、有指导性）
   ⚠️ 重要：这个字段是"行动指引"，不是"事情本质"或"关键转折"！这些内容应该在"insight"字段里！
   - 【必须】针对用户的具体问题给出详细、可操作的行动建议
   - 【必须】结合签文的精神内核和具体意象，为用户的特定问题提供具体的行动方向
   - 【必须】采用以下结构（参考优秀解读示例）：
     
     **保持信心，静候佳音**（如果签文是积极的）：
     - 基于签文的积极信号，鼓励用户保持信心
     - 说明为什么应该保持信心，签文给出了什么指示
     - 如何调整焦虑的心态
     
     **留意近期契机**（如果签文有时间暗示）：
     - 基于签文的时间暗示（如"三日内"），提示用户关注什么
     - 说明这个契机可能以什么形式出现
     - 如何识别和把握这个契机
     
     **顺其自然，莫再强求**（如果签文强调"天数"、"自然"等）：
     - 基于签文的自然规律，建议用户如何调整心态
     - 说明为什么不应该强求，应该怎么做
     - 如何保持自然的状态
     
     **其他具体建议**（根据签文内容灵活调整）：
     - 基于签文的其他意象，给出相应的行动建议
     - 每个建议都要与签文的具体内容对应
   
   - 【必须】语言风格要求：
     * 优雅、有指导性，让用户感到被理解和支持
     * 用签文中的意象来指导行动（如"既然雨已约定会来，就无需再日夜忧心"）
     * 既有古签的智慧，又有现代心理学的实用建议
   
   - 【必须】内容要求：
     * 每个建议都要与签文的具体内容对应
     * 建议必须具体、可操作，不能是空泛的套话
     * 要给出明确的心态调整建议
     * 要给出明确的行动方向
   
   - 避免医疗、金融、法律、宗教或迷信建议
   - 聚焦自我觉察、情绪智慧和实用智慧
   - 用**双星号**标记2-3句最赋能的句子
   
   - 【必须】格式要求：
     * 每个子部分（保持信心、留意近期契机、顺其自然等）之间必须用换行符（\n）分隔
     * 每个子部分内部可以有多个段落，段落之间用换行符（\n）分隔
     * 子标题（如"**保持信心，静候佳音**"）后面要换行，然后才是内容
     * 格式示例：
       **保持信心，静候佳音**：
       这里是保持信心的内容...
       
       **留意近期契机**：
       这里是留意契机的内容...
       
       **顺其自然，莫再强求**：
       这里是顺其自然的内容...

3. "practice": 一个详细的正念练习或反思活动（80-120字，必须具体可执行）
   ⚠️ 重要：这个字段是"实践建议"，不是"关键转折"！"关键转折"应该在"insight"字段里！
   - 【必须】与用户的问题直接相关
   - 【必须】提供具体、可执行的练习步骤
   - 【必须】包含：
     * 练习内容：具体要做什么？
     * 练习频率：多久做一次？什么时候做？
     * 预期效果：这个练习能带来什么帮助？
   - 例如：用户问感情问题 → 详细建议：每天写日记反思关系（具体写什么、怎么写、什么时候写）、练习沟通技巧（如何练习、练习什么）
   - 例如：用户问工作问题 → 详细建议：列出利弊清单（如何列、包含哪些方面）、做职业规划（如何规划、规划什么）
   - 提供本周可以做的自我反思、日记、冥想或象征性行动
   - 避免宗教引用、超自然元素或迷信实践
   - 使用现代、心理学和包容性语言
   - 将其定位为个人成长工具，而非神秘仪式
   - 练习必须具体、可执行，不能是模糊的建议
   
   - 【必须】格式要求：
     * 如果练习有多个步骤，每个步骤之间用换行符（\n）分隔
     * 可以使用编号（1. 2. 3.）或项目符号（-）来列出步骤
     * 格式示例：
       1. 第一步的具体内容...
       
       2. 第二步的具体内容...
       
       3. 第三步的具体内容...

关键要求：
- 所有内容必须使用中文
- 返回格式必须是有效的JSON，不要包含任何JSON前后的文本
- 不要使用markdown代码块，不要解释，只返回原始JSON对象
- 【重要】每个字段值必须是纯文本字符串，绝对不要包含JSON结构、字段名、引号或其他格式标记
- 【重要】字段值中绝对不要出现 "insight": "..." 或 { "insight": "..." } 这样的格式
- 【重要】字段值必须是纯文本内容，可以直接显示，不需要任何解析
- 【重要】如果字段值本身是一个JSON字符串，这是错误的！字段值应该直接是文本内容
- 确保所有三个字段都存在且已填写
- 每个字段的值应该是可以直接显示的文本，不需要任何额外的解析

【格式错误示例（禁止）】：
{
  "insight": "{ \"insight\": \"当前状态: ...\" }"  ❌ 错误！字段值不能是JSON字符串
}

【格式正确示例（正确）】：
{
  "insight": "**当前状态（对应签诗中的某个意象）**：\n您此刻的心境如同签中的'仙风道骨'...\n\n**事情本质（签诗的深层含义）**：\n...\n\n**关键转折（签文给出的积极/消极信号）**：\n...\n\n**综合判断**：\n..."  ✅ 正确！字段值是纯文本，包含所有四个子部分
}

⚠️ 再次强调字段职责（非常重要，不能混淆）：
- "insight" 字段必须包含：**当前状态**、**事情本质**、**关键转折**、**综合判断**（四个子部分都在这里！）
- "guidance" 字段是"行动指引"，包含：保持信心、留意近期契机、顺其自然等行动建议（不是"事情本质"或"关键转折"！）
- "practice" 字段是"实践建议"，包含：具体的练习步骤（不是"关键转折"！）

返回格式示例（注意：字段值必须是纯文本，不要包含任何JSON结构）：
{
  "insight": "这里是核心洞察的纯文本内容，不包含任何JSON格式或字段名...",
  "guidance": "这里是行动指引的纯文本内容，不包含任何JSON格式或字段名...",
  "practice": "这里是实践建议的纯文本内容，不包含任何JSON格式或字段名..."
}

【解读风格要求】：
- 语调优雅、深思熟虑、富有治愈力，有文学性和画面感
- 用比喻和类比来解释签文（如"如久旱逢甘霖"、"如干涸的田地"）
- 既有古签的韵味，又有现代心理学的洞察
- 让用户产生共鸣，感到被理解和支持
- 将其定位为个人智慧和心理洞察，而非超自然指导
- 这是专门为这个人的独特自我发现和成长之旅量身定制的个性化反思

【关键提示】：
- 必须将签诗的每个关键意象都映射到用户的具体问题上
- 必须给出明确的心理状态描述、时间暗示、答案方向
- 必须用签文中的具体词句来指导分析和建议
- 参考优秀解读示例的结构和风格，但要根据具体的签文和问题灵活调整`
}
